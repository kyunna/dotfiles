function fish_greeting
end

if status is-interactive
    ### Path Configuration ###
    # Add user binary path first to ensure local commands are available
    if test -d "$HOME/.local/bin"
        fish_add_path "$HOME/.local/bin"
    end

    ### Basic Tools Configuration ###
    # Editor and common command aliases
    if type -q nvim
        set -gx EDITOR nvim
        alias vim="nvim"
    end
    if type -q lsd
        alias ls="lsd"
    end
    if type -q lazygit
        alias lg="lazygit"
    end

    {{- $isMacOS := and (eq .chezmoi.os "darwin") (stat "/Applications/1Password.app") -}}
    {{- $isWSL := and (eq .chezmoi.os "linux") (.chezmoi.kernel.osrelease | lower | contains "microsoft") -}}
    {{- $isLinux := and (eq .chezmoi.os "linux") (stat "/opt/1Password/1password") -}}

    {{- if or $isMacOS $isWSL $isLinux }}

    ### SSH Agent Configuration ###
    # 1Password SSH agent setup
    {{- if $isMacOS }}
    # macOS: Use 1Password SSH agent
    set -gx SSH_AUTH_SOCK "$HOME/Library/Group Containers/2BUA8C4S2C.com.1password/t/agent.sock"
    {{- else if $isWSL }}
    # WSL: Redirect SSH commands to Windows
    alias ssh="ssh.exe"
    alias ssh-add="ssh-add.exe"
    alias sftp="sftp.exe"
    {{- else if $isLinux }}
    # Linux: Use 1Password SSH agent
    set -gx SSH_AUTH_SOCK "$HOME/.1password/agent.sock"
    {{- end }}

    {{- end }}

    ### Development Environment Setup ###
    # Volta environment setup
    if test -d "$HOME/.volta/bin"
        set -gx VOLTA_HOME "$HOME/.volta"
        fish_add_path "$HOME/.volta/bin"
    end

    ### Shell Integrations ###
    # Initialize shell enhancements and tools
    if type -q fzf
        fzf --fish | source

        # Base FZF options with preview support
        set -l fzf_base_opts "--height 40% --layout=reverse --border --style full \
            --bind 'ctrl-f:preview-page-down,ctrl-b:preview-page-up'"
        set -l fzf_color_opts "--color 'border:#5f8fb0,label:#d6deeb' \
            --color 'preview-border:#8e5fd0,preview-label:#d4a5f5' \
            --color 'list-border:#3d7ea8,list-label:#7db7ff' \
            --color 'input-border:#6b8f8f,input-label:#b8e673'"

        # Set preview command based on available tools
        if type -q bat
            set -l fzf_preview_opts "--preview 'bat --style=numbers --color=always --line-range :100 {}'"
            set -gx FZF_DEFAULT_OPTS "$fzf_base_opts $fzf_preview_opts $fzf_color_opts"
        else
            set -l fzf_preview_opts "--preview 'fzf-preview.sh {}'"
            set -gx FZF_DEFAULT_OPTS "$fzf_base_opts $fzf_preview_opts $fzf_color_opts"
        end

        # Ctrl+R (insert command from history) - with no preview
        set -gx FZF_CTRL_R_OPTS "--no-preview"

        # Alt+C (cd into directory) - with directory preview
        if type -q lsd
            set -gx FZF_ALT_C_OPTS "--preview 'lsd -al --tree --date + --color always {} | head -100'"
        else
            set -gx FZF_ALT_C_OPTS "--preview 'ls -alh {} | head -100'"
        end

        # Set default command based on available tools
        if type -q fd
            set -gx FZF_DEFAULT_COMMAND "fd --type f --hidden --follow --exclude .git"
        else if type -q rg
            set -gx FZF_DEFAULT_COMMAND "rg --files --hidden --follow --glob '!.git'"
        end
    end

    if type -q zoxide
        zoxide init fish | source
    end

    if type -q starship
        starship init fish | source
    end
end
